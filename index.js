const data= [
    {
        "_id": "66d3e4129ea587a652888c42",
        "consecutivo": 8,
        "siOrder": true,
        "seller": "0",
        "sellerName": "despachadorcitos",
        "client": "COCOHOUSE SAS",
        "nit": "901476759",
        "delivery": "2024-09-02T16:48:14.554Z",
        "notes": "",
        "state": 0,
        "id_compras": "",
        "totalReq": 33,
        "TotalDisp": 0,
        "orderItem": [
            {
                "code": "09",
                "product": "Alm. x 180 g",
                "qty": 33,
                "dispatch": 0,
                "_id": "66d3e4129ea587a652888c43",
                "historyDisp": []
            }
        ],
        "createdAt": "Sat Aug 31 2024 22:48:34 GMT-0500 (hora estándar de Colombia)",
        "updatedAt": "2024-09-01T03:48:34.000Z"
    },
    {
        "_id": "66d3e4bf9ea587a652888c81",
        "consecutivo": 1009,
        "siOrder": false,
        "seller": "0",
        "sellerName": "despachadorcitos",
        "client": "QUIMEX S.A.",
        "nit": "890324692",
        "delivery": "2024-09-02T16:51:02.960Z",
        "notes": "",
        "state": 1,
        "id_compras": "",
        "totalReq": 5,
        "TotalDisp": 5,
        "orderItem": [
            {
                "loteAveria": "16416",
                "causalAveria": "Empaque defectuoso",
                "code": "09",
                "product": "Almendra x 180 g",
                "qty": 5,
                "dispatch": 5,
                "_id": "66d3e4bf9ea587a652888c82",
                "historyDisp": [
                    {
                        "fechaHistory": "2024-09-01T03:51:45.414Z",
                        "dspHistory": "wios",
                        "qtyHistory": 4,
                        "loteVenta": "17364",
                        "_id": "66d3e4d19ea587a652888c95"
                    },
                    {
                        "fechaHistory": "2024-09-01T03:51:55.415Z",
                        "dspHistory": "wios",
                        "qtyHistory": 1,
                        "loteVenta": "17439",
                        "_id": "66d3e4db9ea587a652888ca0"
                    }
                ]
            }
        ],
        "createdAt": "Sat Aug 31 2024 22:51:27 GMT-0500 (hora estándar de Colombia)",
        "updatedAt": "2024-09-01T03:51:58.714Z"
    },
    {
        "_id": "66d452ec9ea587a652888cd8",
        "consecutivo": 9,
        "siOrder": true,
        "seller": "0",
        "sellerName": "despachadorcitos",
        "client": "ALKOSTO - TUQUERRES",
        "nit": "1085",
        "delivery": "2024-09-02T16:39:55.233Z",
        "notes": "Cita para la noche",
        "state": 1,
        "id_compras": "000987654",
        "totalReq": 51,
        "TotalDisp": 0,
        "orderItem": [
            {
                "code": "30",
                "product": "Pan. Ctdo 220 ",
                "qty": 12,
                "dispatch": 0,
                "_id": "66d452ec9ea587a652888cd9",
                "historyDisp": []
            },
            {
                "code": "08",
                "product": "Pan. x 200 g",
                "qty": 12,
                "dispatch": 0,
                "_id": "66d452ec9ea587a652888cda",
                "historyDisp": []
            },
            {
                "code": "39",
                "product": "Lnja Combinada",
                "qty": 12,
                "dispatch": 0,
                "_id": "66d452ec9ea587a652888cdb",
                "historyDisp": []
            },
            {
                "code": "13",
                "product": "Lnja Roja",
                "qty": 15,
                "dispatch": 0,
                "_id": "66d452ec9ea587a652888cdc",
                "historyDisp": []
            }
        ],
        "createdAt": "Sun Sep 01 2024 06:41:32 GMT-0500 (hora estándar de Colombia)",
        "updatedAt": "2024-09-01T11:44:40.151Z"
    },
    {
        "_id": "66dfa2955a85f2116fa4368f",
        "consecutivo": 10,
        "siOrder": true,
        "seller": "0",
        "sellerName": "despachadorcitos",
        "client": "TULIO OSWALDO BASTIDAS QUINTANA",
        "nit": "98385639",
        "delivery": "2024-09-10T16:35:46.682Z",
        "notes": "",
        "state": 0,
        "id_compras": "",
        "totalReq": 30,
        "TotalDisp": 20,
        "orderItem": [
            {
                "code": "10",
                "product": "Alm. Cor 160 g",
                "qty": 9,
                "dispatch": 9,
                "_id": "66dfa2955a85f2116fa43690",
                "historyDisp": [
                    {
                        "fechaHistory": "2024-09-10T01:36:48.448Z",
                        "dspHistory": "wios",
                        "qtyHistory": 9,
                        "loteVenta": "17403",
                        "_id": "66dfa2b05a85f2116fa436a6"
                    }
                ]
            },
            {
                "code": "09",
                "product": "Alm. x 180 g",
                "qty": 8,
                "dispatch": 8,
                "_id": "66dfa2955a85f2116fa43691",
                "historyDisp": [
                    {
                        "fechaHistory": "2024-09-10T01:37:02.835Z",
                        "dspHistory": "wios",
                        "qtyHistory": 3,
                        "loteVenta": "17223",
                        "_id": "66dfa2be5a85f2116fa436b4"
                    },
                    {
                        "fechaHistory": "2024-09-10T01:37:10.450Z",
                        "dspHistory": "wios",
                        "qtyHistory": 5,
                        "loteVenta": "17439",
                        "_id": "66dfa2c65a85f2116fa436c3"
                    }
                ]
            },
            {
                "code": "05",
                "product": "Alm. x 200 g",
                "qty": 7,
                "dispatch": 1,
                "_id": "66dfa2955a85f2116fa43692",
                "historyDisp": [
                    {
                        "fechaHistory": "2024-09-10T01:37:32.252Z",
                        "dspHistory": "wios",
                        "qtyHistory": 1,
                        "loteVenta": "15405",
                        "_id": "66dfa2dc5a85f2116fa436d5"
                    }
                ]
            },
            {
                "code": "03",
                "product": "Alm. x 25 estuche",
                "qty": 6,
                "dispatch": 2,
                "_id": "66dfa2955a85f2116fa43693",
                "historyDisp": [
                    {
                        "fechaHistory": "2024-09-10T01:38:08.255Z",
                        "dspHistory": "wios",
                        "qtyHistory": 2,
                        "loteVenta": "6624",
                        "_id": "66dfa3005a85f2116fa436f0"
                    }
                ]
            }
        ],
        "createdAt": "Mon Sep 09 2024 20:36:21 GMT-0500 (hora estándar de Colombia)",
        "updatedAt": "2024-09-10T01:38:08.381Z"
    }
]


// +***********  FUNCIONES DE PRUEBA
// funciona bien hasta el primer nivel only, antes de 2.0
function unwindAndFlatten(data) {
    const result = [];
    const fields = new Map();

    data.forEach((item) => {
        const baseEntry = {};
        Object.keys(item).forEach(key => {
            // Si la propiedad no es un array, lo asignamos al baseEntry
            if (!Array.isArray(item[key])) {
                baseEntry[key] = item[key];

                // Agregar el campo y su tipo si no está registrado
                if (!fields.has(key)) {
                    fields.set(key, typeof item[key]);
                }
            } else {
                // Si la propiedad es un array, iteramos sobre sus elementos
                item[key].forEach(subItem => {
                    const newEntry = { ...baseEntry }; // Clonamos los valores base
                    Object.keys(subItem).forEach(subKey => {
                        const newFieldKey = `${key}_${subKey}`; // Creamos una nueva clave para el campo
                        newEntry[newFieldKey] = subItem[subKey];

                        // Agregar el campo y su tipo si no está registrado
                        if (!fields.has(newFieldKey)) {
                            fields.set(newFieldKey, typeof subItem[subKey]);
                        }
                    });
                    result.push(newEntry); // Añadir la nueva entrada al resultado
                });
            }
        });
    });

    // Convertir el Map a un array de objetos { name, type }
    const fieldsArray = Array.from(fields, ([name, type]) => ({ name, type }));

    return { result, fields: fieldsArray };
}





//version 2.0
/*
function unwindAndFlatten(data) {
    const result = [];
    const fields = new Map();
  
    function flatten(item, parentKey = '') {
      Object.entries(item).forEach(([key, value]) => {
        const newKey = parentKey ? `${parentKey}_${key}` : key;
  
        if (typeof value === 'object' && value !== null) {
          flatten(value, newKey);
        } else {
          result.push({ [newKey]: value });
          fields.set(newKey, typeof value);
        }
      });
    }
  
    data.forEach(item => flatten(item));
  
    // Convertir el Map a un array de objetos { name, type }
    const fieldsArray = Array.from(fields, ([name, type]) => ({ name, type }));
  
    return { result, fields: fieldsArray };
  }
*/
/*function unwindToObjects(data, parentObj = {}, result = []) {
    if (Array.isArray(data)) {
        // Iterar sobre el array y mantener los datos del padre
        data.forEach(item => unwindToObjects(item, { ...parentObj }, result));
    } else if (typeof data === 'object' && data !== null) {
        let hasNestedArray = false;

        Object.keys(data).forEach(key => {
            if (Array.isArray(data[key])) {
                // Si es un array, desenrollarlo manteniendo los datos del padre
                hasNestedArray = true;
                unwindToObjects(data[key], { ...parentObj }, result);
            } else if (typeof data[key] === 'object' && data[key] !== null) {
                // Si es un objeto, desenrollarlo sin perder los datos del padre
                unwindToObjects(data[key], { ...parentObj, [key]: data[key] }, result);
            } else {
                // Guardar el valor del campo plano
                parentObj[key] = data[key];
            }
        });
result.push(parentObj);
        if (!hasNestedArray) {
            // Solo guardar cuando no hay arrays anidados
            
        }
    }
    return result;
}
*/


/*
esta funciona bien para claves de primer nivel
function groupByField(data, field) {
    return data.reduce((acc, item) => {
        // Verificamos si la clave del elemento contiene el campo que queremos agrupar
        const fieldKey = data.find(i => i.key.endsWith(field) && i.key.startsWith(item.key.split('.')[0]));

        if (!fieldKey) {
            console.error(`El campo "${field}" no se encontró en los datos.`);
            return acc;
        }

        const groupKey = fieldKey.value; // El valor por el que vamos a agrupar

        if (!acc[groupKey]) {
            acc[groupKey] = [];
        }

        acc[groupKey].push(item);
        return acc;
    }, {});
}
*/



function exploreObject(obj, depth = 0, parentKey = '') {
    const indent = ' '.repeat(depth * 2); 
    if (Array.isArray(obj)) {
        console.log('parent ', [obj])
        obj.forEach((item, index) => {
            console.log(`${indent}  [${index}]`);
            exploreObject(item, depth + 1, parentKey); 
        });
    } else if (typeof obj === 'object' && obj !== null) {
        for (let key in obj) {
            if (obj.hasOwnProperty(key)) {
                console.log(Array.isArray(key))
                console.log(`${indent}  ${parentKey}${key}:`);
                exploreObject(obj[key], depth + 1, parentKey); 
            }
        }
    } else {
        console.log(`${indent}${obj}`); // Caso base: valor simple
    }
}






















exploreObject(data);
//unwind(data)

function unwind(dataUnwind, parentKey = '', result = [], fields = new Map()){
    console.log(dataUnwind)
    if (Array.isArray(dataUnwind)) {
        dataUnwind.forEach((item, index) => {
            const newKey = parentKey ? `${parentKey}.${index}` : `${index}`;
            console.log('nuevc  a K ', newKey);
            unwind(item, newKey, result, fields);
        });
    }else{
        Object.keys(dataUnwind).forEach(key => {
            console.log('es campo ',key)
        })
    }
}










